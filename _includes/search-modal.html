<!-- Search Modal -->
<div id="search-modal" class="search-modal" style="display: none;">
  <div class="search-modal-overlay" onclick="closeSearchModal()"></div>
  <div class="search-modal-content">
    <div class="search-modal-header">
      <input type="text" id="search-modal-input" placeholder="搜索文章..." autocomplete="off" autofocus>
      <button class="search-modal-close" onclick="closeSearchModal()">&times;</button>
    </div>
    <div id="search-modal-results"></div>
  </div>
</div>

<script>
let posts = [];

// Fetch search data
fetch('{{ "/search.json" | relative_url }}')
  .then(response => response.json())
  .then(data => { posts = data; })
  .catch(error => console.error('Error fetching search data:', error));

// Open modal
function openSearchModal() {
  document.getElementById('search-modal').style.display = 'flex';
  document.getElementById('search-modal-input').focus();
  document.body.style.overflow = 'hidden';
}

// Close modal
function closeSearchModal() {
  document.getElementById('search-modal').style.display = 'none';
  document.getElementById('search-modal-input').value = '';
  document.getElementById('search-modal-results').innerHTML = '';
  document.body.style.overflow = '';
}

// Keyboard shortcut: Ctrl+K or Cmd+K
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    openSearchModal();
  }
  if (e.key === 'Escape') {
    closeSearchModal();
  }
});

// Search functionality
const searchInput = document.getElementById('search-modal-input');
const searchResults = document.getElementById('search-modal-results');

if (searchInput) {
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();

    if (query.length === 0) {
      searchResults.innerHTML = '';
      return;
    }

    const filteredPosts = posts.filter(post => {
      const title = post.title ? post.title.toLowerCase() : '';
      const content = post.content ? post.content.toLowerCase() : '';
      return title.includes(query) || content.includes(query);
    });

    displayResults(filteredPosts, query);
  });
}

function displayResults(results, query) {
  if (results.length === 0) {
    searchResults.innerHTML = '<p class="search-no-results">没有找到相关文章</p>';
    return;
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

  const html = results.map(post => {
    let snippet = '';
    if (post.content) {
      const contentLower = post.content.toLowerCase();
      let index = contentLower.indexOf(query);
      if (index === -1) index = 0;

      const start = Math.max(0, index - 50);
      const end = Math.min(post.content.length, index + 150);
      snippet = post.content.substring(start, end);

      if (start > 0) snippet = '...' + snippet;
      if (end < post.content.length) snippet = snippet + '...';

      const safeSnippet = escapeHtml(snippet);
      snippet = safeSnippet.replace(regex, match => `<mark>${match}</mark>`);
    }

    const safeTitle = escapeHtml(post.title || '');
    const safeDate = escapeHtml(post.date || '');
    const safeUrl = escapeHtml(post.url || '#');

    return `
      <div class="search-result-item">
        <div class="search-result-title">
          <a href="${safeUrl}" onclick="closeSearchModal()">${safeTitle}</a>
        </div>
        <div class="search-result-date">${safeDate}</div>
        <div class="search-result-snippet">${snippet}</div>
      </div>
    `;
  }).join('');

  searchResults.innerHTML = html;
}
</script>
